name: Daily Regulatory Update Check

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 02:00 UTC (10:00 Beijing)
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    name: Check for regulatory content updates
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests pyyaml

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run update check
        id: check
        run: |
          python scripts/fetch_updates.py --check-all --report --output /tmp/update_report.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Read report
        id: report
        run: |
          if [ -f /tmp/update_report.json ]; then
            SUMMARY=$(python -c "import json; d=json.load(open('/tmp/update_report.json')); print(d['summary'])")
            COUNT=$(python -c "import json; d=json.load(open('/tmp/update_report.json')); print(d['updates_found'])")
            echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate content drafts and create PR
        if: steps.report.outputs.count != '0'
        run: |
          python scripts/generate_content_pr.py --report /tmp/update_report.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}

      - name: Create tracking issue if updates found
        if: steps.report.outputs.count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('/tmp/update_report.json', 'utf8'));
            const updates = report.updates;

            let body = `## Automated Regulatory Update Detection\n\n`;
            body += `**Detected at**: ${report.checked_at}\n`;
            body += `**Updates found**: ${report.updates_found}\n\n`;
            body += `### Updates Requiring Review\n\n`;

            for (const u of updates) {
              body += `#### ${u.name}\n`;
              body += `- **Category**: \`${u.category}\`\n`;
              body += `- **URL**: ${u.url}\n`;
              body += `- **Note**: ${u.note}\n`;
              if (u.new_items) {
                body += `- **New items**:\n`;
                for (const item of u.new_items.slice(0, 5)) {
                  body += `  - [${item.title}](${item.link})\n`;
                }
              }
              body += `\n`;
            }

            body += `---\n`;
            body += `*A draft PR with bilingual content stubs has been auto-created.*\n`;
            body += `*This issue was automatically created by the update monitoring workflow.*\n`;
            body += `*Please review the draft PR and update the knowledge base accordingly.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto] Regulatory updates detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['update', 'automated']
            });
